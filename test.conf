#!/usr/sbin/nft -f

flush ruleset

table inet filter {
    # Subnets
    define WAN = 100.64.0.0/24
    define DMZ = 100.64.19.0/24
    define LAN = 10.21.32.0/24

    # Interfaces on A
    define IFwan = "ens192"
    define IFdmz = "ens224"
    define IFlan = "ens256"

    # Facebook IP (from your dig)
    define FB = 57.144.104.1

    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback
        iif "lo" accept

        # Stateful
        ct state { established, related } accept
        ct state invalid drop

        # ICMP so we can ping/traceroute the router
        ip protocol icmp icmp type {
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded
        } accept

    
        tcp dport 22 accept
        iifname $IFwan udp dport 67 accept
        udp dport 123 accept
        tcp dport 4113 accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

     
        ct state { established, related } accept

        iifname $IFwan oifname $IFdmz jump WAN2DMZ
        iifname $IFwan oifname $IFlan jump WAN2LAN

        iifname $IFdmz oifname $IFwan jump DMZ2WAN
        iifname $IFdmz oifname $IFlan jump DMZ2LAN

        iifname $IFlan oifname $IFdmz jump LAN2DMZ
        iifname $IFlan oifname $IFwan jump LAN2WAN
    }

    chain WAN2DMZ {
        ip protocol icmp icmp type {
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded
        } accept

        udp dport 53 accept
        tcp dport { 22, 80, 4113 } accept
    }

    chain WAN2LAN {
    }


    chain DMZ2WAN {
      
        ip protocol icmp icmp type {
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded
        } accept

        udp dport 53 accept
        tcp dport { 53, 80, 443 } accept
    }

    chain DMZ2LAN {
        ip protocol icmp icmp type {
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded
        } accept

        tcp dport { 22, 2049 } accept
    }


    chain LAN2DMZ {
        ip saddr $LAN accept
    }

    chain LAN2WAN {
        ip daddr $FB drop
        ip saddr $LAN accept
    }
}

table ip nat {
    chain POSTROUTING {
        type nat hook postrouting priority srcnat; policy accept;
        oifname $IFwan ip saddr $LAN masquerade
    }
}
